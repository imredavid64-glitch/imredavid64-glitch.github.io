<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analog Artifact Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the retro/glitch look */
        :root {
            --primary-color: #34d399; /* Bright terminal green */
            --secondary-color: #f87171; /* Faded red for AI/Publish */
            --background-color: #000000; /* Deep black */
        }

        @keyframes flicker {
            0% { opacity: 0.9; }
            5% { opacity: 0.7; }
            10% { opacity: 1.0; }
            15% { opacity: 0.8; }
            20% { opacity: 0.95; }
            25% { opacity: 0.6; }
            100% { opacity: 1.0; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--primary-color); /* Primary text color is green */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Styling the canvas for maximum visual impact - CRT look */
        #outputCanvas, #generatedImage {
            box-shadow: 0 0 30px rgba(52, 211, 153, 0.6); /* Neon green glow */
            border: 2px solid var(--primary-color);
            transition: all 0.3s ease-in-out;
            background-color: #000;
            /* CRT Distortion Effect */
            filter: contrast(1.2) hue-rotate(0deg); /* Slight contrast boost */
            border-radius: 8px; /* Subtle curve simulation */
        }
        
        /* Apply dark, high-contrast style to input elements */
        .bg-gray-800 {
            background-color: #111111; /* Very dark gray for controls panel */
            border: 1px solid var(--primary-color);
        }

        /* Container for the gallery item image */
        .gallery-image-container {
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            position: relative;
            overflow: hidden;
        }

        .gallery-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .gallery-item:hover .gallery-image {
            transform: scale(1.05);
        }

        /* Styling the custom file input button */
        .file-upload-label {
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: #000000;
            font-weight: 800;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.1s;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .file-upload-label:hover {
            background-color: #10b981; /* Darker emerald on hover */
            transform: translateY(-1px);
        }
        
        /* Hide the default file input */
        #videoFile {
            display: none;
        }

        /* Style for the control buttons */
        .control-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            color: #000;
            transition: background-color 0.2s;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        .control-btn.emerald-btn {
            background-color: var(--primary-color);
        }
        .control-btn.emerald-btn:hover {
            background-color: #10b981;
        }

        .control-btn.red-btn {
            background-color: var(--secondary-color);
            color: #000;
        }
        .control-btn.red-btn:hover {
            background-color: #ef4444;
        }

        .control-btn.publish-btn {
            background-color: #f59e0b; /* Amber */
        }
        .control-btn.publish-btn:hover {
            background-color: #d97706;
        }

        .story-preview {
            background-color: #000;
            color: var(--primary-color);
            padding: 1rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 0.875rem;
            line-height: 1.4;
            border: 2px solid var(--primary-color);
        }
        
        /* Input styling for terminal look */
        .w-full.p-2.bg-gray-700 {
            background-color: #000;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        /* Message box styling */
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            background-color: #f87171; /* Faded Red */
            color: #000;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .message-box.show {
            opacity: 1;
        }

        /* === Creepypasta/Archive Styling === */
        
        /* New style for the archive section header */
        .archive-header {
            font-family: 'Times New Roman', serif; /* Classic font for documents */
            color: #FBBF24; /* Amber/Yellow for importance */
            border-bottom: 2px dashed #92400E; /* Dark brown/sepia dashed line */
        }

        /* Style for the gallery items - making them look like documents/files */
        .archive-item {
            background-color: #f7f3e8; /* Faded paper/parchment color */
            color: #1a1a1a; /* Dark text on light background */
            border: 3px solid #6b4c30; /* Darker, rustic border */
            box-shadow: 4px 4px 0 #92400E; /* Offset shadow for 3D/physical effect */
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Times New Roman', serif;
        }
        .archive-item:hover {
            transform: translate(-2px, -2px); /* Lift effect */
            box-shadow: 6px 6px 0 #92400E;
        }

        /* Specific styling for story cards */
        .story-card {
            padding: 1rem;
            min-height: 250px; /* Ensure visual height */
            max-height: 250px;
            overflow: hidden;
            position: relative;
            border-bottom: 1px dashed #6b4c30;
        }
        .story-card::after {
            content: "FILE ENDS ABRUPTLY";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            background: linear-gradient(to bottom, transparent, #f7f3e8 80%);
            padding-top: 2rem;
            font-size: 0.75rem;
            font-style: italic;
            color: #f87171; /* Faded red text */
        }

        /* Styling for image containers inside the archive look */
        .image-frame {
            border-bottom: 1px solid #6b4c30;
            background-color: #111111; /* Dark background for the image itself */
        }

        .artifact-meta {
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- === TITLE SCREEN / LANDING PAGE === -->
    <div id="titleScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-black transition-opacity duration-1000">
        <div class="text-center p-8 border-4 border-dashed border-red-500 rounded-lg shadow-2xl shadow-red-500/50">
            <h1 class="text-6xl md:text-8xl font-extrabold mb-4 tracking-tighter text-red-400 [text-shadow:0_0_10px_#f87171]">
                BROKEN SIGNAL
            </h1>
            <h2 class="text-2xl md:text-4xl font-light mb-8 text-emerald-400 [text-shadow:0_0_8px_#34d399]">
                ANALOG ARTIFACT GENERATOR V1.2
            </h2>
            <p class="text-sm text-gray-500 mb-6">
                System Scan Complete. Accessing Archive.
            </p>
            <button id="startButton" class="bg-emerald-400 hover:bg-emerald-300 text-black font-extrabold py-3 px-8 rounded-lg text-xl uppercase transition-all duration-200 shadow-lg shadow-emerald-500/50 hover:shadow-emerald-500/80 active:translate-y-1" style="animation: flicker 1.5s infinite alternate;">
                BEGIN TRANSMISSION
            </button>
        </div>
    </div>
    <!-- =================================== -->


    <!-- === EDITOR CONTAINER (Initially Hidden) === -->
    <div id="editorContainer" class="w-full max-w-7xl flex flex-col items-center" style="display: none;">

        <header class="text-center mb-8 w-full">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2 tracking-wider">
                A<span class="text-red-400">RTIFACT</span> GENERATOR
            </h1>
            <p class="text-lg text-gray-400">Generate image, upload video, or write a chilling narrative.</p>
        </header>

        <main class="w-full flex flex-col lg:flex-row gap-8">
            <!-- Controls Panel -->
            <div class="lg:w-1/3 bg-gray-800 p-6 rounded-xl shadow-2xl h-fit">
                
                <!-- AI ARTIFACT GENERATION -->
                <h2 class="text-2xl font-semibold text-red-400 mb-4 border-b border-red-700 pb-2">
                    AI Image Artifact (Type: Image)
                </h2>

                <div class="space-y-4 mb-8">
                    <div>
                        <label for="generationPrompt" class="block text-sm font-medium text-gray-300 mb-1">
                            Prompt (e.g., "A dark figure standing in a cornfield")
                        </label>
                        <textarea id="generationPrompt" rows="3" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-sm text-white focus:ring-red-500 focus:border-red-500" placeholder="Describe your horror scene..."></textarea>
                    </div>

                    <div>
                        <label for="generationStyle" class="block text-sm font-medium text-gray-300 mb-1">
                            Style Template
                        </label>
                        <select id="generationStyle" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-sm text-white focus:ring-red-500 focus:border-red-500">
                            <option value="A grainy VHS found footage">Standard VHS Found Footage</option>
                            <option value="A vintage 1970s broadcast interception, distorted and dark, Dr. Nowhere style">Dr. Nowhere Style</option>
                            <option value="A digitally corrupted high contrast broadcast, black and white, Mandela Catalogue style">Mandela Catalogue Style</option>
                            <option value="A low-resolution security camera still from the 1990s, green filter">90s CCTV Style</option>
                            <option value="A distorted black and white transmission, heavy static and broken lines">Extreme Static</option>
                            <option value="1980s TV broadcast style, emergency alert graphics, yellow and black text, low saturation, Local 58 style">Local 58 Broadcast Interruption</option>
                            <option value="Gloomy, fluorescent-lit liminal space, wide-angle lens, low-detail photo, VHS recording, Kane Pixels style">Kane Pixels/Found Footage Liminal</option>
                            <option value="Infinite yellow wallpapered rooms, buzzing fluorescent lights, heavy fog, liminal space, backrooms aesthetic">Backrooms Aesthetic</option>
                            <option value="Early 2000s digital video compression artifacting, heavy pixelation, greenish hue, low bit rate">Early 2000s Digital Glitch</option>
                            <option value="Pure black and white signal, heavy horizontal white noise and intermittent signal cuts, pure static">Heavy Static Interruption</option>
                            <option value="Obscure deep web lost media video still, extremely dark and poorly lit, with mysterious foreign subtitles">Lost Media/Deep Web</option>
                            <option value="Low-polygon 3D rendered image, early 90s video game graphics, corrupted textures, uncanny atmosphere, horror, Mario 64 style">Corrupted Mario 64/90s 3D Horror</option>
                            <option value="PS1 survival horror game screenshot, grainy textures, fixed camera angle, low poly character, silent hill style">PS1 Survival Horror Game Screenshot</option>
                            <option value="1990s desktop screenshot, low resolution monitor, blocky green text, terminal interface, computer screen artifact">90s Desktop Terminal Interface</option>
                            <option value="CGI graphics from late 90s educational video, high contrast black text on white background, low frame rate, Gemini Home Entertainment aesthetic">Gemini Home Entertainment CGI</option>
                            <option value="Simple, unsettling 2D animation frame, crude drawings, high contrast, black and white figures, Boisvert style">Boisvert Crude Animation Style</option>
                            <option value="Analog home video tape, heavy tracking lines, burnt-in timecode, slightly corrupted, warm colors">Classic Video Tape Look</option>
                        </select>
                    </div>

                    <button id="generateBtn" class="control-btn red-btn w-full text-lg font-bold">
                        GENERATE ARTIFACT
                    </button>
                    <p id="generationLoading" class="text-red-400 text-center" style="display:none;">
                        Generating... Please wait. This may take up to 30 seconds.
                    </p>
                </div>
                <!-- END AI ARTIFACT GENERATION -->
                
                <!-- STORY ARTIFACT GENERATION -->
                <h2 class="text-2xl font-semibold text-emerald-400 mb-4 border-b border-gray-700 pb-2 mt-8">
                    Text Artifact (Type: Story)
                </h2>
                <div class="space-y-4 mb-8">
                    <div>
                        <label for="storyTitle" class="block text-sm font-medium text-gray-300 mb-1">
                            Story Title (e.g., "Broadcast Log 001")
                        </label>
                        <input type="text" id="storyTitle" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-sm text-white focus:ring-emerald-500 focus:border-emerald-500" placeholder="A chilling title...">
                    </div>
                    <div>
                        <label for="storyContent" class="block text-sm font-medium text-gray-300 mb-1">
                            Analog Horror Narrative
                        </label>
                        <textarea id="storyContent" rows="8" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-sm text-white focus:ring-emerald-500 focus:border-emerald-500" placeholder="Start your transmission log or chilling document here..."></textarea>
                    </div>
                    <button id="publishStoryBtn" class="control-btn emerald-btn w-full text-lg font-bold">
                        PUBLISH STORY
                    </button>
                </div>
                <!-- END STORY ARTIFACT GENERATION -->

                <h2 class="text-2xl font-semibold text-emerald-400 mb-4 border-b border-gray-700 pb-2">Video Input & Filter Controls</h2>

                <!-- File Upload -->
                <input type="file" id="videoFile" accept="video/*" onchange="loadVideo(event)">
                <label for="videoFile" class="file-upload-label block text-center mb-6">
                    Upload Analog Source
                </label>

                <div id="videoControls" class="space-y-4" style="display:none;">
                    <h3 class="text-xl font-medium text-white border-b border-gray-700 pb-2 mb-4">Visual Distortion Settings</h3>

                    <!-- Glitch Intensity Slider -->
                    <div>
                        <label for="glitchIntensity" class="block text-sm font-medium text-gray-300">
                            Glitch Intensity: <span id="glitchValue" class="text-emerald-400">7</span>
                        </label>
                        <input type="range" id="glitchIntensity" min="0" max="15" value="7" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg mt-1" oninput="document.getElementById('glitchValue').textContent = this.value;">
                    </div>

                    <!-- Color Shift Slider -->
                    <div>
                        <label for="colorShift" class="block text-sm font-medium text-gray-300">
                            Color Bleed (VHS Tracking): <span id="colorShiftValue" class="text-emerald-400">5</span>
                        </label>
                        <input type="range" id="colorShift" min="0" max="10" value="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg mt-1" oninput="document.getElementById('colorShiftValue').textContent = this.value;">
                    </div>

                    <!-- Monochrome Toggle -->
                    <div class="flex items-center justify-between pt-2">
                        <span class="text-sm font-medium text-gray-300">Monochrome (B&W)</span>
                        <input type="checkbox" id="monochromeToggle" class="form-checkbox h-5 w-5 text-emerald-500 bg-gray-700 rounded border-gray-600 focus:ring-emerald-500">
                    </div>

                    <!-- Scanlines Toggle -->
                    <div class="flex items-center justify-between pt-2">
                        <span class="text-sm font-medium text-gray-300">Apply Scanlines</span>
                        <input type="checkbox" id="scanlinesToggle" checked class="form-checkbox h-5 w-5 text-emerald-500 bg-gray-700 rounded border-gray-600 focus:ring-emerald-500">
                    </div>

                    <!-- AUDIO DISTORTION CONTROLS -->
                    <h3 class="text-xl font-medium text-white border-b border-gray-700 pb-2 mb-4 mt-8">Audio Distortion Settings</h3>
                    <div class="space-y-4">
                        <!-- Static Noise Slider -->
                        <div>
                            <label for="noiseIntensity" class="block text-sm font-medium text-gray-300">
                                Static/Hum Volume: <span id="noiseValue" class="text-emerald-400">0.5</span>
                            </label>
                            <input type="range" id="noiseIntensity" min="0" max="1" step="0.05" value="0.5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg mt-1" oninput="document.getElementById('noiseValue').textContent = this.value;">
                        </div>
                        <!-- Low-Pass Filter (Muffle) Slider -->
                        <div>
                            <label for="muffleFrequency" class="block text-sm font-medium text-gray-300">
                                Low-Fidelity Muffle (Hz): <span id="muffleValue" class="text-emerald-400">1000</span>
                            </label>
                            <input type="range" id="muffleFrequency" min="500" max="10000" step="100" value="1000" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg mt-1" oninput="document.getElementById('muffleValue').textContent = this.value;">
                        </div>
                    </div>
                    <!-- END AUDIO DISTORTION CONTROLS -->

                    <div class="pt-4">
                        <button id="playbackBtn" class="control-btn emerald-btn w-full text-lg font-bold bg-gray-600 hover:bg-gray-700 text-white transition-all">
                            PAUSE
                        </button>
                    </div>
                </div>
            </div>

            <!-- Video Output Area -->
            <div class="lg:w-2/3 flex flex-col items-center">
                <div id="canvasContainer" class="w-full aspect-video flex justify-center items-center bg-gray-900 rounded-xl shadow-inner relative">
                    <!-- Output Canvas (for video filtering) -->
                    <canvas id="outputCanvas" class="max-w-full max-h-full rounded-lg transition-shadow duration-300" style="display:none;"></canvas>
                    
                    <!-- Image Output (for generation) -->
                    <img id="generatedImage" class="max-w-full max-h-full rounded-lg object-contain" style="display:none;" alt="Generated Analog Horror Image">

                    <!-- Initial Placeholder Message -->
                    <p id="placeholderText" class="text-2xl text-gray-500 transition-opacity p-8 text-center">
                        Awaiting video file or AI prompt...
                    </p>
                    <p id="loadingText" class="text-2xl text-emerald-400 transition-opacity p-8 text-center absolute" style="display:none;">
                        Processing video and starting filter...
                    </p>
                </div>

                <!-- Publish Button (only visible after image generation) -->
                <button id="publishBtn" class="control-btn publish-btn w-full lg:w-3/4 mt-4 text-lg font-bold" style="display:none;">
                    PUBLISH IMAGE ARTIFACT
                </button>

                <!-- Hidden Video Element for Source -->
                <video id="sourceVideo" style="display:none;" loop></video>
            </div>
        </main>
        
        <!-- Gallery Section -->
        <section class="w-full max-w-6xl mt-12">
            <h2 class="text-3xl font-bold archive-header mb-6 pb-2">
                ARCHIVE OF LOST TRANSMISSIONS (LOGS)
            </h2>
            <p class="text-sm text-gray-400 mb-4">
                Review files pulled from the public cache. Your ID is essential for tracking: <span id="currentUserId" class="font-mono text-emerald-400">Loading...</span>
            </p>

            <div id="artifactsGallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Artifacts will be loaded here by JavaScript -->
                <p id="galleryLoadingText" class="col-span-4 text-center text-gray-500">Connecting to the void...</p>
            </div>
        </section>
        
    </div>
    <!-- =================================== -->


    <!-- Custom Message Box for non-intrusive errors/notifications -->
    <div id="messageBox" class="message-box" role="alert"></div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTS AND INITIALIZATION ---
        const video = document.getElementById('sourceVideo');
        const canvas = document.getElementById('outputCanvas');
        const generatedImage = document.getElementById('generatedImage');
        const ctx = canvas.getContext('2d');
        const placeholderText = document.getElementById('placeholderText');
        const loadingText = document.getElementById('loadingText');
        const videoControls = document.getElementById('videoControls');
        const playbackBtn = document.getElementById('playbackBtn');
        const publishBtn = document.getElementById('publishBtn'); // Publish Image
        const publishStoryBtn = document.getElementById('publishStoryBtn'); // Publish Story
        
        // New Title Screen Elements
        const titleScreen = document.getElementById('titleScreen');
        const editorContainer = document.getElementById('editorContainer');
        const startButton = document.getElementById('startButton');

        // Generation Controls
        const generateBtn = document.getElementById('generateBtn');
        const generationPromptInput = document.getElementById('generationPrompt');
        const generationStyleSelect = document.getElementById('generationStyle');
        const generationLoadingText = document.getElementById('generationLoading');
        
        // Story Controls
        const storyTitleInput = document.getElementById('storyTitle');
        const storyContentArea = document.getElementById('storyContent');

        // Filter Controls
        const glitchIntensityInput = document.getElementById('glitchIntensity');
        const colorShiftInput = document.getElementById('colorShift');
        const scanlinesToggle = document.getElementById('scanlinesToggle');
        const monochromeToggle = document.getElementById('monochromeToggle'); 

        // Audio Controls
        const noiseIntensityInput = document.getElementById('noiseIntensity'); 
        const muffleFrequencyInput = document.getElementById('muffleFrequency'); 

        // Audio API Globals
        let audioContext = null;
        let videoSource = null;
        let biquadFilter = null;
        let noiseGain = null;
        let noiseSource = null; 

        // Gallery Elements
        const artifactsGallery = document.getElementById('artifactsGallery');
        const galleryLoadingText = document.getElementById('galleryLoadingText');
        const currentUserIdSpan = document.getElementById('currentUserId');

        let isPlaying = false;
        let animationFrameId = null;
        let currentArtifactData = null; // Stores data for the last generated image

        // Firebase Globals
        let db = null;
        let auth = null;
        let userId = null;
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const generateImageUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${''}`; // API Key handled by runtime

        // --- TITLE SCREEN LOGIC ---
        startButton.addEventListener('click', () => {
            // Hide title screen (using opacity for smooth transition)
            titleScreen.style.opacity = '0';
            // After transition, hide it fully and show the editor
            setTimeout(() => {
                titleScreen.style.display = 'none';
                editorContainer.style.display = 'flex'; // Use flex to maintain layout flow
                editorContainer.classList.add('flex-col');
            }, 1000);
        });


        // --- FIREBASE SETUP ---
        function initializeFirebase() {
            try {
                setLogLevel('Debug');
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (Object.keys(firebaseConfig).length === 0) {
                     console.warn("Firebase configuration is missing.");
                     return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Sign in anonymously if no token, otherwise use custom token
                        if (initialAuthToken) {
                            try {
                                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                                userId = userCredential.user.uid;
                            } catch (e) {
                                console.error("Custom token sign-in failed:", e);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    }
                    currentUserIdSpan.textContent = userId;
                    subscribeToArtifacts(); 
                });
            } catch(e) {
                console.error("Firebase initialization failed:", e);
                galleryLoadingText.textContent = "Error: Could not connect to the gallery database.";
            }
        }

        // --- FIRESTORE FUNCTIONS ---

        /**
         * Listens to the public collection of artifacts and updates the gallery.
         */
        function subscribeToArtifacts() {
            if (!db) return;

            const collectionPath = `/artifacts/${APP_ID}/public/data/analogHorrorArtifacts`;
            // Using orderBy for initial query structure, but sorting client-side for safety.
            const q = query(collection(db, collectionPath), orderBy("timestamp", "desc"), limit(20)); 

            onSnapshot(q, (snapshot) => {
                artifactsGallery.innerHTML = '';
                galleryLoadingText.style.display = 'none';

                if (snapshot.empty) {
                    artifactsGallery.innerHTML = '<p class="col-span-4 text-center text-gray-500">No artifacts published yet. Be the first!</p>';
                    return;
                }

                const artifactsArray = [];
                snapshot.forEach((doc) => {
                    artifactsArray.push(doc.data());
                });

                // Client-side sort to ensure consistent order without relying on complex Firestore indices
                artifactsArray.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                artifactsArray.forEach(artifact => {
                     artifactsGallery.appendChild(createGalleryItem(artifact));
                });

            }, (error) => {
                console.error("Error subscribing to artifacts:", error);
                artifactsGallery.innerHTML = `<p class="col-span-4 text-center text-red-500">Failed to load archive: ${error.message}</p>`;
            });
        }

        /**
         * Publishes the current generated image artifact to Firestore.
         */
        async function publishImageArtifact() {
            if (!db || !currentArtifactData || currentArtifactData.type !== 'image') {
                showMessage("Nothing to publish. Generate an image first.", 3000);
                return;
            }

            publishBtn.disabled = true;
            publishBtn.textContent = 'Publishing...';
            
            try {
                const collectionPath = `/artifacts/${APP_ID}/public/data/analogHorrorArtifacts`;
                await addDoc(collection(db, collectionPath), {
                    ...currentArtifactData,
                    userId: userId,
                    timestamp: serverTimestamp(),
                });

                showMessage("Image Artifact published successfully to the Archive!", 4000);
                publishBtn.style.display = 'none';
                currentArtifactData = null; // Clear data after successful publish

            } catch (error) {
                console.error("Error publishing image artifact:", error);
                showMessage("Failed to publish image artifact: " + error.message, 5000);
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = 'PUBLISH IMAGE ARTIFACT';
            }
        }
        
        /**
         * Publishes the user-written story artifact to Firestore.
         */
        async function publishStoryArtifact() {
            const title = storyTitleInput.value.trim();
            const content = storyContentArea.value.trim();

            if (!db) {
                showMessage("Database connection failed. Please check initialization.", 3000);
                return;
            }
            if (!title || !content) {
                showMessage("Please provide both a title and content for your story.", 3000);
                return;
            }

            publishStoryBtn.disabled = true;
            publishStoryBtn.textContent = 'Publishing...';

            try {
                const collectionPath = `/artifacts/${APP_ID}/public/data/analogHorrorArtifacts`;
                await addDoc(collection(db, collectionPath), {
                    type: 'story',
                    title: title,
                    content: content,
                    userId: userId,
                    timestamp: serverTimestamp(),
                });

                showMessage("Story Artifact published successfully to the Archive!", 4000);
                // Clear the input fields
                storyTitleInput.value = '';
                storyContentArea.value = '';

            } catch (error) {
                console.error("Error publishing story artifact:", error);
                showMessage("Failed to publish story artifact: " + error.message, 5000);
            } finally {
                publishStoryBtn.disabled = false;
                publishStoryBtn.textContent = 'PUBLISH STORY';
            }
        }


        /**
         * Creates the HTML element for a single artifact in the gallery (Creepypasta Style).
         */
        function createGalleryItem(artifact) {
            const container = document.createElement('div');
            // Use the new archive style class
            container.className = 'archive-item rounded-lg overflow-hidden shadow-xl transition-shadow duration-300';
            
            const time = artifact.timestamp ? new Date(artifact.timestamp.seconds * 1000).toLocaleString() : 'N/A';
            
            let contentHtml = '';
            let artifactTypeTag = '';
            let mainTitle = '';

            if (artifact.type === 'image') {
                const styleName = generationStyleSelect.querySelector(`option[value="${artifact.style}"]` )?.textContent || artifact.style || 'Digital Print';
                
                // Image artifact with a title block and image frame
                contentHtml = `
                    <div class="image-frame">
                        <div class="text-xs text-center p-2 border-b border-gray-400 bg-gray-200 text-gray-800">
                            [[ ARTIFACT IMAGE LOG ${new Date().getFullYear()} ]]
                        </div>
                        <div class="gallery-image-container">
                            <img src="${artifact.image}" alt="Analog Horror Artifact" class="gallery-image opacity-90">
                        </div>
                    </div>
                `;
                artifactTypeTag = `<span class="text-xs font-bold text-red-700 uppercase">Image/Visual Scan</span>`;
                // Truncate the prompt for the title
                mainTitle = `<p class="font-bold text-md">${artifact.prompt.substring(0, 40)}${artifact.prompt.length > 40 ? '...' : ''}</p>`;

            } else if (artifact.type === 'story') {
                // Limit the content snippet displayed
                const snippet = artifact.content.substring(0, 500).trim();
                
                // Story artifact mimicking a faded document
                contentHtml = `
                    <div class="story-card">
                        <h3 class="text-xl font-bold mb-2 text-red-800">${artifact.title}</h3>
                        <p class="text-sm italic whitespace-pre-wrap">${snippet}</p>
                    </div>
                `;
                artifactTypeTag = `<span class="text-xs font-bold text-green-700 uppercase">Text/Transmission Log</span>`;
                mainTitle = `<p class="font-bold text-md">${artifact.title}</p>`;
            }


            container.innerHTML = `
                ${contentHtml}
                <div class="artifact-meta">
                    ${mainTitle}
                    <div class="mt-1 flex justify-between items-center">
                        ${artifactTypeTag}
                        <span class="text-xs text-gray-600">${time}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Submitter: ${artifact.userId.substring(0, 8)}...</p>
                </div>
            `;
            return container;
        }


        // --- UTILITIES ---

        /**
         * Utility function to show a custom message box instead of alert().
         */
        function showMessage(message, duration = 3000) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.classList.add('show');
            setTimeout(() => {
                box.classList.remove('show');
            }, duration);
        }
        
        /**
         * Hides all primary output elements and shows the specified one.
         */
        function switchOutput(elementToShow, showPublishImageButton = false) {
            canvas.style.display = 'none';
            generatedImage.style.display = 'none';
            placeholderText.style.display = 'none';
            loadingText.style.display = 'none';
            // videoControls.style.display is handled separately by loadVideo

            // Only show image publish button if condition is met AND Firebase is ready
            if (showPublishImageButton && userId && db) {
                publishBtn.style.display = 'block';
            } else {
                publishBtn.style.display = 'none';
            }

            if (elementToShow) {
                elementToShow.style.display = 'block';
            }
        }

        // --- AI GENERATION LOGIC ---

        async function generateArtifact() {
            stopProcessing(); // Stop any active video filtering
            
            const userPrompt = generationPromptInput.value.trim();
            const style = generationStyleSelect.value.trim();
            
            if (!userPrompt) {
                showMessage("Please enter a description for the image artifact.", 3000);
                return;
            }

            // Construct the final prompt
            const finalPrompt = `${userPrompt}. Style: ${style}. Extremely grainy, poor tracking, faded colors, static distortion, low resolution, found footage look, analog horror.`;

            // Prepare UI for generation
            switchOutput(placeholderText, false);
            placeholderText.textContent = "Initiating analog transmission...";
            generationLoadingText.style.display = 'block';
            generateBtn.disabled = true;

            const payload = { 
                instances: { prompt: finalPrompt }, 
                parameters: { "sampleCount": 1 } 
            };
            
            const maxRetries = 5;
            let currentRetry = 0;
            
            const makeApiCall = async () => {
                try {
                    const response = await fetch(generateImageUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        
                        generatedImage.src = imageUrl;
                        generatedImage.onload = () => {
                            // Store the artifact data for publishing
                            currentArtifactData = {
                                type: 'image',
                                prompt: userPrompt,
                                style: style,
                                image: imageUrl,
                            };
                            switchOutput(generatedImage, true); // Show image and publish button
                            showMessage("Analog Image Artifact successfully generated!", 3000);
                        };
                    } else {
                        throw new Error("API response missing image data.");
                    }
                } catch (error) {
                    console.error("API Call Failed:", error);
                    if (currentRetry < maxRetries) {
                        currentRetry++;
                        const delay = Math.pow(2, currentRetry) * 1000;
                        console.log(`Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return makeApiCall(); // Recursive retry
                    } else {
                        switchOutput(placeholderText, false);
                        placeholderText.textContent = "Generation failed. Please check your prompt and try again.";
                        showMessage("Artifact generation failed after multiple retries.", 5000);
                    }
                } finally {
                    generationLoadingText.style.display = 'none';
                    generateBtn.disabled = false;
                }
            };
            
            makeApiCall();
        }

        // --- AUDIO API FUNCTIONS ---

        /**
         * Initializes the AudioContext and sets up the node graph for video and noise.
         */
        function setupAudioGraph() {
            // Check for user gesture requirement and suspended state
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    // Attempt to resume on first interaction
                    audioContext.resume();
                }
            }

            // Cleanup old nodes
            if (videoSource) { videoSource.disconnect(); }
            if (biquadFilter) { biquadFilter.disconnect(); }
            if (noiseSource) { 
                 noiseSource.stop();
                 noiseSource.disconnect();
            }

            // 1. Video Source Node
            videoSource = audioContext.createMediaElementSource(video);

            // 2. Biquad Filter (Low-pass for Muffle)
            biquadFilter = audioContext.createBiquadFilter();
            biquadFilter.type = "lowpass";
            biquadFilter.Q.value = 0.5; 

            // 3. Noise Generation (White Noise)
            noiseGain = audioContext.createGain();
            
            // Generate and loop a white noise buffer
            const bufferSize = audioContext.sampleRate * 2; // 2 seconds of noise
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1; // Random value between -1 and 1
            }

            noiseSource = audioContext.createBufferSource();
            noiseSource.buffer = noiseBuffer;
            noiseSource.loop = true;
            noiseSource.start(0);

            // Connect the noise to the gain node and then to the destination
            noiseSource.connect(noiseGain);
            noiseGain.connect(audioContext.destination);

            // 4. Connect Video Source through Filter to Destination
            videoSource.connect(biquadFilter);
            biquadFilter.connect(audioContext.destination);

            // Apply initial values
            updateAudioFilters();
        }

        /**
         * Updates the BiquadFilter frequency and noise volume based on UI inputs.
         */
        function updateAudioFilters() {
            if (audioContext && biquadFilter) {
                const freq = parseFloat(muffleFrequencyInput.value);
                biquadFilter.frequency.setValueAtTime(freq, audioContext.currentTime);
            }
            if (audioContext && noiseGain) {
                const gain = parseFloat(noiseIntensityInput.value);
                // Use exponential ramp for smooth transitions when changing volume
                noiseGain.gain.exponentialRampToValueAtTime(gain, audioContext.currentTime + 0.1); 
            }
        }

        // Add event listeners for audio controls
        noiseIntensityInput.addEventListener('input', updateAudioFilters);
        muffleFrequencyInput.addEventListener('input', updateAudioFilters);

        // --- VIDEO LOADING LOGIC ---

        /**
         * Loads the selected video file into the hidden video element.
         */
        function loadVideo(event) {
            const file = event.target.files[0];
            if (!file) {
                showMessage("No file selected.", 3000);
                return;
            }

            if (video.src) {
                URL.revokeObjectURL(video.src);
            }

            const videoURL = URL.createObjectURL(file);
            video.src = videoURL;

            switchOutput(loadingText, false); // Hide publish button for video

            video.onloadedmetadata = () => {
                // Ensure video is muted initially before playing to set up the audio graph
                // But since we are connecting the source, we don't need to mute the element itself.

                video.play().then(() => {
                    setupCanvas();
                    setupAudioGraph(); // Setup audio processing
                    startProcessing();
                    videoControls.style.display = 'block';
                    loadingText.style.display = 'none';
                    canvas.style.display = 'block';
                    showMessage("Video and analog filters active. Adjust sound in controls.", 4000);
                }).catch(error => {
                    console.error("Error starting video playback:", error);
                    showMessage(`Could not start playback. Is the video format supported? (${error.message})`);
                    switchOutput(placeholderText, false);
                    placeholderText.textContent = "Error: Could not start video playback.";
                });
            };

            video.onerror = () => {
                console.error("Error loading video file.");
                showMessage("Error loading video file. Check format or size.", 5000);
                switchOutput(placeholderText, false);
                placeholderText.textContent = "Error: Failed to load video file.";
            };
        }

        /**
         * Sets the canvas dimensions to match the video dimensions.
         */
        function setupCanvas() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        // --- FILTERING AND RENDERING LOGIC ---

        /**
         * Main drawing and filtering loop using requestAnimationFrame.
         */
        function processFrame() {
            if (!isPlaying || video.paused || video.ended) {
                cancelAnimationFrame(animationFrameId);
                return;
            }

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;

            const glitchIntensity = parseFloat(glitchIntensityInput.value);
            const colorShiftAmount = parseInt(colorShiftInput.value, 10);
            const applyScanlines = scanlinesToggle.checked;
            const applyMonochrome = monochromeToggle.checked; 

            const timeFactor = Math.sin(video.currentTime * 10) * 0.5 + 0.5;
            const randomShift = Math.random() * glitchIntensity * timeFactor;
            const horizontalShift = Math.floor(randomShift * 2);

            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const i = (y * w + x) * 4;

                    const displacedX = x + horizontalShift;
                    if (displacedX >= 0 && displacedX < w) {
                        const gOffsetI = i + colorShiftAmount * 4;
                        const bOffsetI = i - colorShiftAmount * 4;

                        // Color bleed
                        data[i + 1] = data[gOffsetI + 1] || data[i + 1]; // Green
                        data[i + 2] = data[bOffsetI + 2] || data[i + 2]; // Blue
                    }
                    
                    // Monochrome conversion
                    if (applyMonochrome) {
                        const avg = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                        data[i] = avg;
                        data[i + 1] = avg;
                        data[i + 2] = avg;
                    }

                    // Scanlines
                    if (applyScanlines && y % 2 === 1) {
                        data[i] = Math.max(0, data[i] - 30);
                        data[i + 1] = Math.max(0, data[i + 1] - 30);
                        data[i + 2] = Math.max(0, data[i + 2] - 30);
                    }

                    // Random Vertical Flicker
                    if (Math.random() < 0.0001 * glitchIntensity) {
                        const lineCorruption = 50 * glitchIntensity;
                        for (let k = 0; k < 40; k++) {
                            const corruptionIndex = i + k * 4;
                            data[corruptionIndex] = Math.min(255, data[corruptionIndex] + Math.random() * lineCorruption);
                            data[corruptionIndex + 1] = Math.min(255, data[corruptionIndex + 1] - Math.random() * lineCorruption);
                            data[corruptionIndex + 2] = Math.min(255, data[corruptionIndex + 2] + Math.random() * lineCorruption);
                        }
                        break;
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);
            animationFrameId = requestAnimationFrame(processFrame);
        }

        /**
         * Starts the video and the processing loop.
         */
        function startProcessing() {
            if (!isPlaying) {
                // Resume AudioContext if it was suspended (e.g., from user interaction pause)
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                isPlaying = true;
                video.play();
                playbackBtn.textContent = 'PAUSE';
                animationFrameId = requestAnimationFrame(processFrame);
                
                // Restore noise volume when playing
                if (audioContext && noiseGain) {
                     const gain = parseFloat(noiseIntensityInput.value);
                     // Smoothly ramp up the volume
                     noiseGain.gain.exponentialRampToValueAtTime(gain, audioContext.currentTime + 0.2);
                }
            }
        }

        /**
         * Stops the video and the processing loop.
         */
        function stopProcessing() {
            if (isPlaying) {
                isPlaying = false;
                video.pause();
                playbackBtn.textContent = 'PLAY';
                cancelAnimationFrame(animationFrameId);

                // Stop audio filtering smoothly
                if (audioContext && noiseGain) {
                    // Smoothly ramp down the volume to near zero
                    noiseGain.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5); 
                }
            }
        }

        // --- EVENT LISTENERS ---
        playbackBtn.addEventListener('click', () => {
            if (isPlaying) {
                stopProcessing();
            } else {
                startProcessing();
            }
        });

        generateBtn.addEventListener('click', generateArtifact);
        publishBtn.addEventListener('click', publishImageArtifact);
        publishStoryBtn.addEventListener('click', publishStoryArtifact);


        // Ensure canvas respects aspect ratio on resize
        window.addEventListener('resize', setupCanvas);

        // --- GLOBAL INITIALIZATION ---
        initializeFirebase();

    </script>
</body>
</html>
